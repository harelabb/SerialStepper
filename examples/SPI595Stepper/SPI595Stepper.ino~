#include <SerialStepper.h>
#include <spi595stepper.h>

#include <SPI.h>

// // Define the stepper motors
constexpr int latch_pin = 4; // for Attiny85
Spi595StepperControl stepper_ctl(latch_pin);
Stepper stp0(stepper_ctl);
Stepper stp1(stepper_ctl);
Stepper stp2(stepper_ctl);
Stepper stp3(stepper_ctl);
Stepper stp4(stepper_ctl);
Stepper stp5(stepper_ctl);
Stepper stp6(stepper_ctl);
Stepper stp7(stepper_ctl);
Stepper* steppers[] = {&stp0, &stp1, &stp2, &stp3,
                       &stp4, &stp5, &stp6, &stp7};
constexpr int nsteppers = sizeof(steppers) / sizeof(steppers[0]);

void setup() {
  // Initialize libraries
//  SPI.setFrequency(1000000);
  SPI.begin();

  // Initialize the stepper motor controller
  stepper_ctl.begin();

  // Set different speed for each motor
  for (int i = 0; i < nsteppers; ++i) {
    steppers[i]->speed(15 - 1.0f * i);
  }
}

void loop() {
  loopClock::tick();

  for (auto s : steppers) {
    if (!s->running()) {
      s->direction(!s->direction());
      s->turn(0.5);
    }
  }

  // Move the steppers if due time
  stepper_ctl.run();
  yield();
}
